<section class="section mt-0 mb-6" id="subscriptionPlans">
  <div class="container-fluid text-center">
    {{#if subscriptionPlans.length}}
      <div class="container-header mb-4">Subscription Plans</div>
    {{/if}}

    <div class="row row-gap-4 justify-content-center">
      {{#each subscriptionPlans}}
      <div class="col-xl-3 col-lg-4 col-md-6 col-12" id="subscriptionCard-{{policyID}}">
        <div class="card dev-card subscription-card">
          <div class="card-body align-items-center text-center p-4">
            <span class="subscription-plans-card-title d-block mb-3">{{displayName}}</span>
            
            {{!-- Price + Rate Limit panel --}}
            <div class="plan-kpis">

              {{!-- PRICE ROW --}}
              <div class="plan-kpi-row">
                <div class="plan-kpi-label">Price</div>

                <div class="plan-kpi-valueTop">
                  {{#if pricingModel}}
                    {{#compare pricingModel "===" "FLAT"}}
                      {{#if flatAmount}}
                        <span class="plan-kpi-amount">{{currency}} {{formatPrice flatAmount}}</span>
                        <span class="plan-kpi-unit">/{{billingPeriod}}</span>
                      {{else}}
                        <span class="plan-kpi-free">Free</span>
                      {{/if}}
                    {{else}}
                      {{!-- PER_UNIT pricing --}}
                      {{#if unitAmount}}
                        <span class="plan-kpi-amount">{{currency}} {{formatPrice unitAmount}}</span>
                        <span class="plan-kpi-unit">/req</span>
                      {{else}}
                        <span class="plan-kpi-free">Free</span>
                      {{/if}}
                    {{/compare}}
                  {{else}}
                    <span class="plan-kpi-free">Free</span>
                  {{/if}}
                </div>

                <div class="plan-kpi-labelSub"></div>
                  <div class="plan-kpi-valueSub">
                  {{#compare pricingModel "===" "PER_UNIT"}}
                    {{#if unitAmount}}
                      {{#if billingPeriod}}
                        <span class="plan-kpi-badge">
                          Billed
                          {{#compare billingPeriod "===" "month"}}monthly{{else}}{{billingPeriod}}ly{{/compare}}
                        </span>
                      {{else}}
                        <span class="plan-kpi-badge-placeholder">&nbsp;</span>
                      {{/if}}
                    {{else}}
                      <span class="plan-kpi-badge-placeholder">&nbsp;</span>
                    {{/if}}
                  {{else}}
                    <span class="plan-kpi-badge-placeholder">&nbsp;</span>
                  {{/compare}}
                </div>
              </div>

              <div class="plan-kpi-divider"></div>

              {{!-- RATE LIMIT ROW --}}
              <div class="plan-kpi-row">
                <div class="plan-kpi-label">Rate limit</div>

                <div class="plan-kpi-valueTop">
                  <span class="plan-kpi-amount">{{requestCount}}</span>
                  <span class="plan-kpi-unit">req/min</span>
                </div>

                <div class="plan-kpi-labelSub"></div>
                <div class="plan-kpi-valueSub">
                  <span class="plan-kpi-badge-placeholder">&nbsp;</span>
                </div>
              </div>
            </div>

            {{!-- Description if available --}}
            {{#if description}}
            <p class="text-muted small mb-3" style="font-size: 12px; line-height: 1.5;">{{description}}</p>
            {{/if}}
          </div>

          <div class="position-relative">
            {{#if ../isAuthenticated}}

            <div id="subscriptionBox" class="subscription-container">
              <div class="custom-dropdown show" id="landing-customDropdown-{{policyID}}">
                <input type="hidden" id="landing-selectedAppId-{{policyID}}" value="" />

                <div class="custom-select-container">
                  <div class="select-selected" aria-expanded="false">
                    <span class="selected-text">Create an app</span>
                    <span class="select-arrow"></span>
                  </div>

                  <div class="select-items" role="listbox">
                    <div class="select-search-container">
                      <input
                        type="text"
                        class="select-search-input {{#if @root.isReadOnlyMode}}d-none{{/if}}"
                        placeholder="Find or create an application..."
                        aria-label="Search applications"
                      >
                    </div>

                    <div class="select-items-container">
                      {{#each ../applications}}
                      <div
                        class="select-item {{#if subscribed}}disabled{{/if}}"
                        role="button"
                        data-value="{{id}}"
                        data-app-name="{{name}}"
                      >
                        <div class="d-flex flex-column flex-grow-1">
                          <span class="fw-semibold">{{name}}</span>
                          {{#if subscriptionPolicy}}
                          <small style="font-size: 11px; margin-top: 3px;">
                            <span class="badge" style="background-color: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 10px; font-weight: 600; font-size: 10px;">
                              {{subscriptionPolicy.policyName}}
                            </span>
                          </small>
                          {{/if}}
                        </div>
                        {{#if subscribed}}
                        <img
                          src="https://raw.githubusercontent.com/wso2/docs-bijira/refs/heads/main/en/devportal-theming/success-rounded.svg"
                          alt="Subscribed"
                          class="subscription-icon"
                          style="width: 18px; height: 18px; flex-shrink: 0;"
                        />
                        {{/if}}
                      </div>
                      {{/each}}
                    </div>

                    <div class="create-app-container" style="display: none;">
                      <div class="create-app-option" role="button">
                        Create application "<span class="search-term"></span>"
                      </div>
                    </div>
                  </div>
                </div>
              </div>

         
              {{!-- Subscribe Button --}}
              <a
                id="landing-subscribe-btn-{{policyID}}"
                type="button"
                class="common-btn-primary subscribe-btn {{#if @root.isReadOnlyMode}}disabled{{/if}}"
                data-policy-id="{{policyID}}"
                data-policy-name="{{policyName}}"
                data-external-price-id="{{pricingMetadata.external.priceId}}"
                data-is-paid="{{#if pricingMetadata.external.priceId}}true{{else}}false{{/if}}"
                onclick="handleLandingPlanSubscription('{{@root.orgID}}', '{{../apiMetadata.apiID}}', '{{../apiMetadata.apiReferenceID}}', '{{policyID}}', '{{policyName}}', this)"
              >
                Subscribe
              </a>
            </div>

            {{else}}
              <a
                type="button"
                class="common-btn-primary disabled w-100 subscription-plan-subscribe-btn"
                disabled
              >
                Subscribe
              </a>
            {{/if}}

            <div class="message-overlay hidden">
              <div class="message-content">
                <i class="bi message-icon"></i>
                <p class="message-text"></p>
              </div>
              <button type="button" class="close-message" aria-label="Close message">&times;</button>
            </div>

            {{!-- Stripe embedded checkout container (hidden by default) --}}
            <div id="landing-stripeCheckoutModal-{{policyID}}" class="stripe-checkout-modal" style="display:none;">
              <div id="landing-stripe-checkout-{{policyID}}"></div>
            </div>

          </div>
        </div>
      </div>
      {{/each}}
    </div>

  </div>
</section>
